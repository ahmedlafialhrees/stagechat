<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دردشة صوتية</title>
<style>
:root{--bg:#0f1322;--panel:#141a2c;--muted:#1b2236;--stroke:#2b3550;--ink:#eaf0ff;--lav:#b79cff;--lav2:#a487ff;--gold1:#ffd76b;--gold2:#ffb224;--red1:#ff6b6b;--red2:#ff1f1f}
*{box-sizing:border-box} html,body{height:100dvh;overflow:hidden}
body{margin:0;color:var(--ink);background:linear-gradient(180deg,#0e1220,#0b0f1a);font-family:-apple-system,system-ui,"Segoe UI",Tahoma,Arial}
a{color:inherit;text-decoration:none}
.screen{display:none;height:100dvh}.screen.active{display:block}
/* Login */
.login-card{width:480px;max-width:94vw;margin:40px auto;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--stroke);border-radius:18px;padding:18px 16px 24px;text-align:center;backdrop-filter:blur(10px);box-shadow:0 20px 60px rgba(0,0,0,.55)}
.login-icon{width:64px;height:64px;border-radius:16px;background:#222a3e;display:flex;align-items:center;justify-content:center;margin:6px auto 10px;font-size:28px}
.login-title{margin:0 0 12px;font-size:22px}
.label{display:block;text-align:right;font-size:13px;color:#cfd6ea;margin:10px 2px 6px}
.input{width:100%;background:var(--muted);border:1px solid var(--stroke);border-radius:12px;padding:12px 14px;font-size:16px;color:#fff;outline:none}
.btn-primary{width:100%;margin-top:14px;padding:12px 16px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--lav),var(--lav2));color:#140a2b;font-weight:800;font-size:16px;cursor:pointer}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.name-row{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center}
.avatar-lg{width:56px;height:56px;border-radius:50%;overflow:hidden;border:1px solid var(--stroke);background:#0e1425;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.avatar-lg img{width:100%;height:100%;object-fit:cover}
/* Layout */
.canvas{max-width:920px;margin:0 auto;padding:8px;display:grid;gap:8px;height:100dvh;grid-template-rows:auto 1fr auto auto}
/* Header */
.hdr{height:60px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px}
.hdr .left,.hdr .mid,.hdr .right{display:flex;align-items:center;gap:8px}
.ib{background:#1a2236;border:1px solid var(--stroke);color:#cfd6ea;border-radius:12px;padding:8px 10px;cursor:pointer}
.badge{font-size:10px;padding:2px 8px;border-radius:999px;margin-right:6px;vertical-align:middle}
.badge.owner{background:linear-gradient(90deg,var(--gold1),var(--gold2));color:#1a1200;box-shadow:0 0 12px rgba(255,197,61,.85)}
.badge.admin{background:linear-gradient(90deg,var(--red1),var(--red2));color:#fff;box-shadow:0 0 12px rgba(255,65,65,.85)}
.avatar{width:42px;height:42px;border-radius:50%;border:1px solid var(--stroke);overflow:hidden;display:inline-flex;background:#0e1425}
.avatar img{width:100%;height:100%;object-fit:cover}
/* Messages */
.list{overflow:auto;margin:0;padding:12px;display:flex;flex-direction:column;gap:10px;background:transparent;border:none;border-radius:14px}
.msg{background:rgba(27,34,54,.35);border:1px solid rgba(43,53,80,.45);border-radius:12px;padding:8px 12px;position:relative}
.msg .meta{font-size:12px;color:#cfd6ea;margin-bottom:4px}
.msg .text{font-size:15px}
/* Context actions */
.ctx{margin-top:6px;display:none;gap:6px}
.ctx.show{display:flex}
.btn-chip{background:#212a43;color:#e8edff;border:1px solid var(--stroke);border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
.btn-chip.danger{background:#3a1d25;border-color:#5c2430;color:#ffb7b7}
/* Stage */
.stage-strip{overflow:auto;padding:10px;margin:0;background:linear-gradient(180deg,#171d30,#141a2b);border:1px solid var(--stroke);border-radius:14px}
#stagePanel.collapsed{height:0;padding:0;border:none;overflow:hidden}
#stageToggle{font-weight:700}
.slots{display:flex;align-items:flex-end;gap:10px;overflow-x:auto;padding-bottom:4px;scroll-snap-type:x mandatory}
.slot{min-width:86px;scroll-snap-align:center;text-align:center;padding:8px 6px;display:flex;flex-direction:column;align-items:center}
.lab{order:-1;margin-bottom:4px;font-size:12px;color:#dde4ff;min-height:1em}
.ped{height:12px;width:100%;border-radius:8px;background:linear-gradient(90deg,#9a7b2f,#cfa63b,#9a7b2f);box-shadow:0 4px 14px rgba(255,182,70,.30)}
.bub{width:48px;height:48px;border-radius:50%;margin:6px auto;background:#0c101a;display:flex;align-items:center;justify-content:center;border:3px solid #000;box-shadow:inset 0 0 0 2px #313a5a,0 6px 16px rgba(0,0,0,.40)}
.slot.on .bub{border-color:#d9b356;box-shadow:inset 0 0 0 2px #59461f,0 0 18px rgba(255,220,120,.65)}
.mic-img{width:68%;height:68%;object-fit:contain;filter:drop-shadow(0 3px 6px rgba(0,0,0,.45))}
/* Composer + Emoji */
.pill{width:100%;max-width:880px;margin:0 auto;display:flex;align-items:center;gap:8px;background:#1b2236;border:1px solid var(--stroke);border-radius:999px;padding:8px 10px}
.pill input{flex:1;background:transparent;border:none;outline:none;color:#fff;font-size:16px}
.btn-r{background:linear-gradient(90deg,var(--lav),var(--lav2));border:none;color:#140a2b;font-weight:800;border-radius:12px;padding:8px 12px;cursor:pointer}
.btn-ghost{background:transparent;border:none;color:#cfd6ea;font-size:20px;padding:6px 8px;border-radius:10px;cursor:pointer}
/* Emoji popover */
.popover{position:fixed;bottom:90px;right:12px;background:#171d2e;border:1px solid var(--stroke);border-radius:12px;padding:8px;display:none;box-shadow:0 20px 50px rgba(0,0,0,.5);z-index:9999}
.popover.show{display:grid}
#emojiPanel{grid-template-columns:repeat(8,32px);gap:6px}
#emojiPanel button{background:#1b2236;border:1px solid var(--stroke);border-radius:8px;font-size:20px;padding:6px}
/* Admin panel */
.admin-wrap{max-width:920px;margin:14px auto;padding:10px}
.card{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:12px;margin-bottom:10px}
.card h3{margin:0 0 10px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--stroke);padding:8px;border-radius:6px}
@media (max-width:520px){.row-2,.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
<section id="login" class="screen active">
  <div class="login-card">
    <div class="login-icon">🎧</div>
    <h1 class="login-title">تسجيل الدخول</h1>
    <label class="label">اسمك وصورتك</label>
    <div class="name-row">
      <label class="avatar-lg" title="اختر صورة">
        <input id="loginAvatar" type="file" accept="image/*" hidden>
        <img id="loginAvatarImg" src="https://i.ibb.co/4St3gqK/user.png" alt="avatar">
      </label>
      <input id="displayName" class="input" placeholder="اكتب اسمك (للعضو ممكن تتركه فاضي)">
    </div>
    <label class="label">الدور</label>
    <select id="role" class="input">
      <option value="member">عضو</option>
      <option value="admin">أدمن</option>
      <option value="owner">أونر</option>
    </select>
    <div id="credWrap" class="row-2" style="display:none; margin-top:10px">
      <input id="loginUser" class="input" placeholder="اسم المستخدم (لو عندك حساب مُنشأ)">
      <input id="loginPass" class="input" type="password" placeholder="كلمة السر">
    </div>
    <button id="enterBtn" class="btn-primary">دخول</button>
  </div>
</section>

<section id="chat" class="screen">
  <div class="canvas">
    <header class="hdr">
      <div class="left"><button id="stageToggle" class="ib">▾</button></div>
      <div class="mid"><span class="avatar"><img id="avatarImg" src="" alt="avatar"></span></div>
      <div class="right"><a id="cpLink" class="ib" style="display:none">لوحة التحكم</a><span id="roleBadge"></span><button id="logoutBtn" class="ib">خروج</button></div>
    </header>

    <main class="list" id="messages"></main>

    <div class="stage-strip" id="stagePanel">
      <div class="slots" id="stage">
        <div class="slot"><div class="lab"></div><div class="ped"></div><div class="bub"><img class="mic-img" alt="mic"></div></div>
        <div class="slot"><div class="lab"></div><div class="ped"></div><div class="bub"><img class="mic-img" alt="mic"></div></div>
        <div class="slot"><div class="lab"></div><div class="ped"></div><div class="bub"><img class="mic-img" alt="mic"></div></div>
        <div class="slot"><div class="lab"></div><div class="ped"></div><div class="bub"><img class="mic-img" alt="mic"></div></div>
        <div class="slot"><div class="lab"></div><div class="ped"></div><div class="bub"><img class="mic-img" alt="mic"></div></div>
      </div>
    </div>

    <footer class="composer">
      <div class="pill">
        <button id="emojiBtn" class="btn-ghost">😄</button>
        <input id="msgInput" placeholder="اكتب رسالة..."/>
        <button id="sendBtn" class="btn-r">➤</button>
      </div>
      <div id="emojiPanel" class="popover"></div>
    </footer>
  </div>
</section>

<section id="cp" class="screen">
  <div class="admin-wrap">
    <div class="card"><button class="ib" id="backToChat">⬅ رجوع للدردشة</button></div>
    <div class="card">
      <h3>إنشاء حساب (للأدمن/الأونر)</h3>
      <div class="grid2">
        <input id="newUser" class="input" placeholder="اسم المستخدم">
        <input id="newPass" class="input" placeholder="كلمة السر">
      </div>
      <div style="margin-top:8px" class="grid2">
        <select id="newRole" class="input">
          <option value="admin">أدمن</option>
          <option value="owner">أونر</option>
        </select>
        <button id="applyUser" class="btn-primary">تطبيق</button>
      </div>
    </div>
    <div class="card">
      <h3>الحسابات المحفوظة</h3>
      <table class="table" id="usersTable">
        <thead><tr><th>المستخدم</th><th>الدور</th><th>حذف</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>

<script>
const OWNER_PASS='7770', ADMIN_PASS='7771';
function genGuest(){ return 'ضيف-' + Math.floor(1000 + Math.random()*9000); }
const CHAT_KEY='kw777_local_chat',STAGE_KEY='kw777_local_stage',INFO_KEY='kw777_login_info',AVA_KEY='kw777_avatar';
const USERS_KEY='kw777_users', BAN_KEY='kw777_bans', TEMP_ADMINS_KEY='kw777_temp_admins';

const roleSel=document.getElementById('role'),credWrap=document.getElementById('credWrap'),enterBtn=document.getElementById('enterBtn');
const logoutBtn=document.getElementById('logoutBtn');
const messages=document.getElementById('messages'),msgInput=document.getElementById('msgInput'),roleBadge=document.getElementById('roleBadge');
const avatarImg=document.getElementById('avatarImg');
const loginAvatar=document.getElementById('loginAvatar'),loginAvatarImg=document.getElementById('loginAvatarImg');
const cpLink=document.getElementById('cpLink'), backToChat=document.getElementById('backToChat');

const EMOJIS="😀😄😁😅😂🤣🙂😉😊😍😘😎🤩🥰🤗🙃🤔😴😤😭😡😇🤝👏👍👎🙏🔥✨💯🎉🎁🏆🎧🎤🎵".split("");
const MIC_SRC="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f3a4.svg";

const show=id=>{document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
const esc=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const saveInfo=o=>localStorage.setItem(INFO_KEY,JSON.stringify(o));
const loadInfo=_=>{try{return JSON.parse(localStorage.getItem(INFO_KEY)||'{}')}catch{return{}}};
const getUsers=_=>{try{return JSON.parse(localStorage.getItem(USERS_KEY)||'[]')}catch{return[]}};
const setUsers=a=>localStorage.setItem(USERS_KEY,JSON.stringify(a));
const getBans=_=>{try{return JSON.parse(localStorage.getItem(BAN_KEY)||'{}')}catch{return{}}};
const setBans=m=>localStorage.setItem(BAN_KEY,JSON.stringify(m));
const now=_=>Date.now();
function myName(){ return (loadInfo().name || ''); }
function myRole(){ return (loadInfo().role || 'member'); }

function getTempAdmins(){ try{return JSON.parse(sessionStorage.getItem(TEMP_ADMINS_KEY)||'[]')}catch{return[]} }
function setTempAdmins(arr){ sessionStorage.setItem(TEMP_ADMINS_KEY, JSON.stringify(arr)); }
function addTempAdmin(name){ const arr=getTempAdmins(); if(!arr.includes(name)) arr.push(name); setTempAdmins(arr); }
function isTempAdmin(name){ return getTempAdmins().includes(name); }

function toggleCred(){const r=roleSel.value;credWrap.style.display=(r==='owner'||r==='admin')?'grid':'none';}
roleSel&&roleSel.addEventListener('change',toggleCred);

function removeMyFromStage(){
  const me=myName();
  document.querySelectorAll('#stage .slot.on .lab').forEach(l=>{
    if(l.textContent===me){ l.textContent=''; l.parentElement.classList.remove('on'); }
  });
}
function occupy(slot){
  const me=myName(); if(!me) return;
  const role=myRole();
  const lab=slot.querySelector('.lab');
  const isMine=slot.classList.contains('on') && lab.textContent===me;
  if(isMine){ lab.textContent=''; slot.classList.remove('on'); saveStageSnapshot(); return; }
  if(role==='member' && slot.classList.contains('on') && lab.textContent && lab.textContent!==me){ return; }
  removeMyFromStage(); slot.classList.add('on'); lab.textContent=me; saveStageSnapshot();
}
function saveStageSnapshot(){ const state=[...document.querySelectorAll('#stage .slot')].map(s=>({on:s.classList.contains('on'),lab:s.querySelector('.lab').textContent||''})); localStorage.setItem(STAGE_KEY, JSON.stringify(state)); }
function restoreStage(){ try{ const state=JSON.parse(localStorage.getItem(STAGE_KEY)||'[]'); const slots=[...document.querySelectorAll('#stage .slot')]; state.forEach((s,i)=>{ if(!slots[i]) return; slots[i].classList.toggle('on',!!s.on); slots[i].querySelector('.lab').textContent=s.lab||''; }); }catch{} }
function clearStage(){ document.querySelectorAll('#stage .slot').forEach(s=>{ s.classList.remove('on'); s.querySelector('.lab').textContent=''; }); localStorage.removeItem(STAGE_KEY); }

function addRow(from,text){ 
  const row=document.createElement('div'); 
  row.className='msg'; 
  row.dataset.name=from.name;
  row.innerHTML=`
    <div class="meta">${esc(from.name)}</div>
    <div class="text">${esc(text)}</div>
    <div class="ctx" dir="rtl">
      <button class="btn-chip act-dropFromStage">تنزيل من الاستيج</button>
      <button class="btn-chip act-admin">إعطاء أدمن (جلسة)</button>
      <button class="btn-chip danger act-ban2h">طرد ساعتين</button>
    </div>`;
  messages.appendChild(row); 
  messages.scrollTop=messages.scrollHeight; 
}
function saveChat(m){ const arr=JSON.parse(localStorage.getItem(CHAT_KEY)||'[]'); arr.push({name:m.name,text:m.text,ts:now()}); localStorage.setItem(CHAT_KEY, JSON.stringify(arr.slice(-300))); }
function clearChat(){ localStorage.removeItem(CHAT_KEY); messages.innerHTML=''; }

loginAvatar?.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ loginAvatarImg.src=r.result; localStorage.setItem(AVA_KEY,r.result); }; r.readAsDataURL(f);
});
document.querySelector('.avatar-lg')?.addEventListener('click',()=>loginAvatar.click());

function checkBanned(name){
  const bans=getBans(); const ts=bans[name];
  if(ts && ts>now()){ const mins=Math.ceil((ts-now())/60000); alert(`هذا المستخدم محظور مؤقتًا (${mins} دقيقة متبقية)`); return true; }
  if(ts && ts<=now()){ delete bans[name]; setBans(bans); }
  return false;
}
function validateRoleLogin(role, user, pass){
  if(role==='admin' && isTempAdmin(user)) return true;
  const list=getUsers();
  const item=list.find(u=>u.username===user && u.role===role && u.password===pass);
  if(item) return true;
  if(role==='owner' && pass===OWNER_PASS) return true;
  if(role==='admin' && pass===ADMIN_PASS) return true;
  return false;
}

enterBtn&&enterBtn.addEventListener('click', ()=>{
  let name=(document.getElementById('displayName').value||'').trim();
  const role=roleSel.value;
  const lu=(document.getElementById('loginUser')?.value||'').trim();
  const lp=(document.getElementById('loginPass')?.value||'').trim();

  if(role==='owner'||role==='admin'){
    if(!validateRoleLogin(role, lu || name, lp)){ alert('بيانات غير صحيحة'); return; }
    if(!name) name = (lu || (role==='owner'?'أونر':'أدمن')+'-'+Math.floor(Math.random()*1000));
  }else{
    if(!name) name=genGuest();
  }
  if(checkBanned(name)) return;

  saveInfo({name,role});
  show('chat'); bootChat();
});

function bootChat(){
  const info=loadInfo(),name=info.name||'مستخدم',role=info.role||'member';
  roleBadge.innerHTML=role==='owner'?'<span class="badge owner">owner</span>':role==='admin'?'<span class="badge admin">admin</span>':'';
  cpLink.style.display = (role==='owner') ? 'inline-flex' : 'none';
  cpLink.onclick = ()=>{ renderUsers(); show('cp'); };

  const savedAva=localStorage.getItem(AVA_KEY);
  avatarImg.src=savedAva||"https://i.ibb.co/4St3gqK/user.png";
  document.querySelectorAll('.mic-img').forEach(img=>img.src=MIC_SRC);

  messages.innerHTML='';
  try{ JSON.parse(localStorage.getItem(CHAT_KEY)||'[]').forEach(m=>addRow({name:m.name},m.text)); }catch{}
  messages.scrollTop=messages.scrollHeight;

  restoreStage();
  document.querySelectorAll('#stage .slot').forEach(slot=>{ slot.addEventListener('click',()=>occupy(slot)); });

  const stagePanel=document.getElementById('stagePanel'), stageToggle=document.getElementById('stageToggle'); let collapsed=false;
  stageToggle.onclick=()=>{ collapsed=!collapsed; stagePanel.classList.toggle('collapsed',collapsed); stageToggle.textContent=collapsed?'▸':'▾'; };

  const emojiBtn=document.getElementById('emojiBtn'), emojiPanel=document.getElementById('emojiPanel');
  emojiPanel.innerHTML=EMOJIS.map(e=>`<button type="button">${e}</button>`).join('');
  emojiBtn.onclick=()=>{ emojiPanel.classList.toggle('show'); };
  function onPick(e){ const btn=e.target.closest('button'); if(!btn) return; e.preventDefault(); msgInput.value+=btn.textContent; msgInput.focus(); }
  emojiPanel.addEventListener('pointerdown', onPick, {passive:false});
  emojiPanel.addEventListener('click', onPick);
  document.addEventListener('pointerdown', (e)=>{ if(!e.target.closest('#emojiPanel') && e.target!==emojiBtn){ emojiPanel.classList.remove('show'); } });

  const send=()=>{ const t=(msgInput.value||'').trim(); if(!t) return; saveChat({name,role,text:t}); addRow({name},t); msgInput.value=''; };
  document.getElementById('sendBtn').onclick=send; msgInput.addEventListener('keydown',e=>{ if(e.key==='Enter') send(); });

  messages.addEventListener('click', (e)=>{
    const box=e.target.closest('.msg'); if(!box) return;
    const panel=box.querySelector('.ctx');
    if(role!=='admin' && role!=='owner') return;
    document.querySelectorAll('.ctx.show').forEach(p=>p.classList.remove('show'));
    panel.classList.toggle('show');

    const targetName = box.dataset.name;

    panel.querySelector('.act-dropFromStage').onclick = ()=>{
      let found=false;
      document.querySelectorAll('#stage .slot.on .lab').forEach(l=>{
        if(l.textContent===targetName){ l.textContent=''; l.parentElement.classList.remove('on'); found=true; }
      });
      saveStageSnapshot();
      addRow({name:'النظام'}, found?`تم تنزيل ${targetName} من الاستيج`:`${targetName} ليس على الاستيج`);
      panel.classList.remove('show');
    };

    panel.querySelector('.act-admin').onclick = ()=>{
      addTempAdmin(targetName);
      addRow({name:'النظام'}, `تم إعطاء ${targetName} أدمن (بدون كلمة سر) لهذه الجلسة`);
      panel.classList.remove('show');
    };

    panel.querySelector('.act-ban2h').onclick = ()=>{
      const bans=getBans(); bans[targetName]= Date.now() + 2*60*60*1000; setBans(bans);
      addRow({name:'النظام'}, `${targetName} محظور ساعتين`);
      panel.classList.remove('show');
    };
  });

  logoutBtn.onclick=()=>{ clearChat(); clearStage(); localStorage.removeItem(INFO_KEY); show('login'); };
}

function renderUsers(){
  const tbody=document.querySelector('#usersTable tbody'); tbody.innerHTML='';
  const users=getUsers();
  users.forEach((u,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${esc(u.username)}</td><td>${u.role}</td>
      <td><button class="btn-chip danger" data-i="${i}">حذف</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.onclick=(e)=>{
    const btn=e.target.closest('button[data-i]'); if(!btn) return;
    const idx=+btn.dataset.i; const list=getUsers(); list.splice(idx,1); setUsers(list); renderUsers();
  };
}
document.getElementById('applyUser')?.addEventListener('click', ()=>{
  const u=document.getElementById('newUser').value.trim();
  const p=document.getElementById('newPass').value.trim();
  const r=document.getElementById('newRole').value;
  if(!u || !p) return alert('أدخل اسم مستخدم وكلمة سر');
  const list=getUsers();
  if(list.some(x=>x.username===u)) return alert('الاسم مستخدم');
  list.push({username:u,password:p,role:r});
  setUsers(list); renderUsers();
  alert('تم إنشاء الحساب');
});
backToChat?.addEventListener('click', ()=>show('chat'));
window.addEventListener('beforeunload', ()=>{ clearChat(); removeMyFromStage(); saveStageSnapshot(); });

(function init(){ const a=localStorage.getItem(AVA_KEY); if(a) loginAvatarImg.src=a; toggleCred(); })();
</script>
</body>
</html>
